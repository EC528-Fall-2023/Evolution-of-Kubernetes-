# this script is a test to check if the Image_SBOM scirpts works
# I wanted to see how many sboms it would create for a spceific verison 

import subprocess
import csv

# Function to run Syft and print results to the terminal
def run_syft_and_print(image_name):
    try:
        # Run Syft on the specified image and print the result to the terminal
        result = subprocess.run(["syft", image_name], stdout=subprocess.PIPE, check=True, text=True)
        print(result.stdout)  # Print the result to the terminal
        print(f"Syft analysis completed for image: {image_name}\n")
        return 1  # Return 1 to indicate success
    except subprocess.CalledProcessError:
        print(f"Syft analysis failed for image: {image_name}\n")
        return 0  # Return 0 to indicate failure

# Read container image names from a CSV file (Assuming the CSV file has columns as mentioned)
csv_file_name = "/Users/ussie/Desktop/K8S CLI Tool/Evolution-of-Kubernetes-/SBOM/Parsed SBOM/v1.18.20/v1.18.20_packages_output.csv"

total_images = 0  
successful_images = 0  

with open(csv_file_name, 'r') as csv_file:
    reader = csv.DictReader(csv_file)
    for row in reader:
        package_name = row['PackageName']
        # looking for k8s container images
        if package_name.startswith("k8s.gcr.io"):
            total_images += 1  # Increment the total image count
            image_name = package_name
            # Extract the specific package name from the container image
            package_name_parts = package_name.split("/")
            if len(package_name_parts) > 1:
                package_name = package_name_parts[-1].replace(":", "_").replace("/", "_")
                
            successful_images += run_syft_and_print(image_name)  # Update the successful analysis count

print(f"Total images processed: {total_images}")
print(f"Successful analyses: {successful_analysis}")
